{"version":3,"sources":["../../src/commands/takeElScreenshot.js"],"names":["TakeElScreenshot","nightwatch","customizedSettings","GetEl","call","cmd","util","inherits","prototype","do","magellanSel","self","now","Date","getTime","time","executeAsyncTime","startTime","sel","selectorPrefix","filepath","path","resolve","settings","screenshotPath","sep","filename","client","api","getLocation","location","getElementSize","size","seleniumCallTime","screenshot","result","jimp","read","Buffer","value","err","image","fail","crop","x","y","width","height","write","pass","injectedJsCommand","$el","command","selector","cb","selectorUtil","normalize","successMessage","failureMessage","seenCount","decide","checkConditions","module","exports"],"mappings":";;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;;;AAEA,IAAMA,mBAAmB,SAAnBA,gBAAmB,GAAwD;AAAA,MAA9CC,UAA8C,uEAAjC,IAAiC;AAAA,MAA3BC,kBAA2B,uEAAN,IAAM;;AAC/EC,kBAAMC,IAAN,CAAW,IAAX,EAAiBH,UAAjB,EAA6BC,kBAA7B;AACA,OAAKG,GAAL,GAAW,kBAAX;AACD,CAHD;;AAKAC,eAAKC,QAAL,CAAcP,gBAAd,EAAgCG,eAAhC;;AAEA;AACAH,iBAAiBQ,SAAjB,CAA2BC,EAA3B,GAAgC,UAAUC,WAAV,EAAuB;AACrD,MAAMC,OAAO,IAAb;AACA,MAAMC,MAAO,IAAIC,IAAJ,EAAD,CAAaC,OAAb,EAAZ;AACA,OAAKC,IAAL,CAAUC,gBAAV,GAA6BJ,MAAMD,KAAKM,SAAxC;;AAEA,MAAMC,YAAU,KAAKC,cAAf,SAAiCT,WAAjC,MAAN;AACA,MAAMU,WAAWC,eAAKC,OAAL,CAAa,MAAGC,mBAASC,cAAT,GAA0BH,eAAKI,GAAlC,KACvB,gCAAiBd,KAAKe,QAAtB,CADuB,UAAb,CAAjB;;AAGA,OAAKC,MAAL,CAAYC,GAAZ,CAAgBC,WAAhB,CAA4BX,GAA5B,EAAiC,UAACY,QAAD,EAAc;AAC7CnB,SAAKgB,MAAL,CAAYC,GAAZ,CAAgBG,cAAhB,CAA+Bb,GAA/B,EAAoC,UAACc,IAAD,EAAU;AAC5CrB,WAAKI,IAAL,CAAUkB,gBAAV,GAA8B,IAAIpB,IAAJ,EAAD,CAAaC,OAAb,KAAyBF,GAAtD;;AAEAD,WAAKgB,MAAL,CAAYC,GAAZ,CACGM,UADH,CACc,KADd,EACqB,UAACC,MAAD,EAAY;AAC7BC,uBAAKC,IAAL,CAAU,IAAIC,MAAJ,CAAWH,OAAOI,KAAlB,EAAyB,QAAzB,CAAV,EAA8C,UAACC,GAAD,EAAMC,KAAN,EAAgB;;AAE5D,cAAID,GAAJ,EAAS;AACP7B,iBAAK+B,IAAL,CAAU,EAAV;AACD;;AAEDD,gBAAME,IAAN,CACEb,SAASS,KAAT,CAAeK,CADjB,EAEEd,SAASS,KAAT,CAAeM,CAFjB,EAGEb,KAAKO,KAAL,CAAWO,KAHb,EAIEd,KAAKO,KAAL,CAAWQ,MAJb,EAKGC,KALH,CAKS5B,QALT,EAKmB;AAAA,mBAAMT,KAAKsC,IAAL,CAAU,EAAV,CAAN;AAAA,WALnB;AAMD,SAZD;AAaD,OAfH;AAgBD,KAnBD;AAoBD,GArBD;AAsBD,CA/BD;;AAiCA;AACAjD,iBAAiBQ,SAAjB,CAA2B0C,iBAA3B,GAA+C,UAAUC,GAAV,EAAe;AAC5D,SAAO,gEAAP;AACD,CAFD;;AAIAnD,iBAAiBQ,SAAjB,CAA2B4C,OAA3B,GAAqC,UAAUC,QAAV,EAAoB3B,QAApB,EAA8B4B,EAA9B,EAAkC;AACrE,OAAKD,QAAL,GAAgBE,mBAAaC,SAAb,CAAuBH,QAAvB,CAAhB;AACA,OAAK3B,QAAL,GAAgBA,QAAhB;AACA,OAAK4B,EAAL,GAAUA,EAAV;;AAEA,OAAKG,cAAL,GAAsB,8BAA4B,KAAKJ,QAAjC,UAClB,gCADJ;AAEA,OAAKK,cAAL,GAAsB,mDACd,KAAKL,QADS,6BAAtB;;AAGA,OAAKpC,SAAL,GAAkB,IAAIJ,IAAJ,EAAD,CAAaC,OAAb,EAAjB;;AAEA;AACA,OAAK6C,SAAL,GAAiB,CAAjB;AACA,OAAKC,MAAL;AACA,OAAKC,eAAL;;AAEA,SAAO,IAAP;AACD,CAlBD;;AAoBAC,OAAOC,OAAP,GAAiB/D,gBAAjB","file":"takeElScreenshot.js","sourcesContent":["import jimp from \"jimp\";\nimport path from \"path\";\nimport util from \"util\";\nimport sanitizeFilename from \"sanitize-filename\";\n\nimport selectorUtil from \"../util/selector\";\nimport settings from \"../settings\";\nimport GetEl from \"./getEl\";\n\nconst TakeElScreenshot = function (nightwatch = null, customizedSettings = null) {\n  GetEl.call(this, nightwatch, customizedSettings);\n  this.cmd = \"takeelscreenshot\";\n};\n\nutil.inherits(TakeElScreenshot, GetEl);\n\n/*eslint-disable max-nested-callbacks*/\nTakeElScreenshot.prototype.do = function (magellanSel) {\n  const self = this;\n  const now = (new Date()).getTime();\n  this.time.executeAsyncTime = now - self.startTime;\n\n  const sel = `[${this.selectorPrefix}=${magellanSel}]`;\n  const filepath = path.resolve(`${settings.screenshotPath + path.sep}`\n    + `${sanitizeFilename(self.filename)}.png`);\n\n  this.client.api.getLocation(sel, (location) => {\n    self.client.api.getElementSize(sel, (size) => {\n      self.time.seleniumCallTime = (new Date()).getTime() - now;\n\n      self.client.api\n        .screenshot(false, (result) => {\n          jimp.read(new Buffer(result.value, \"base64\"), (err, image) => {\n\n            if (err) {\n              self.fail({});\n            }\n\n            image.crop(\n              location.value.x,\n              location.value.y,\n              size.value.width,\n              size.value.height)\n              .write(filepath, () => self.pass({}));\n          });\n        });\n    });\n  });\n};\n\n/*eslint no-unused-vars:0 */\nTakeElScreenshot.prototype.injectedJsCommand = function ($el) {\n  return \"return $el[0].getAttribute('data-magellan-temp-automation-id')\";\n};\n\nTakeElScreenshot.prototype.command = function (selector, filename, cb) {\n  this.selector = selectorUtil.normalize(selector);\n  this.filename = filename;\n  this.cb = cb;\n\n  this.successMessage = `Screenshot for selector <${this.selector}> `\n    + \"is taken after %d milliseconds\";\n  this.failureMessage = \"Failed to take screenshot for selector \"\n    + `<${this.selector}> after %d milliseconds`;\n\n  this.startTime = (new Date()).getTime();\n\n  // Track how many times we've seen selector as :visible\n  this.seenCount = 0;\n  this.decide();\n  this.checkConditions();\n\n  return this;\n};\n\nmodule.exports = TakeElScreenshot;\n"]}